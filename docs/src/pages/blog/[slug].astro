---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { Card, CardGrid, Aside, Badge } from '@astrojs/starlight/components';
import { getCollection, type CollectionEntry, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('docs', (entry) => 
    entry.id && entry.id.startsWith('blog/day-')
  );
  
  return posts.map((post) => ({
    params: { slug: post.id.replace('blog/', '') },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'docs'>;
}

const { post } = Astro.props;

// Try to render the content
let Content;
try {
  const result = await render(post);
  Content = result.Content;
} catch (error) {
  console.error('Error rendering post:', error);
  // Fallback if render doesn't work
  Content = () => null;
}

// Extract collaboration data
const dayMatch = post.id.match(/day-(\d+)/);
const day = dayMatch ? parseInt(dayMatch[1]) : null;
const perspective = post.data.authors?.includes('human') ? 'human' : 'claude';

// Find companion post
let companionPost = null;
if (post.data.companion) {
  const allPosts = await getCollection('docs', (entry) => 
    entry.id && entry.id.startsWith('blog/day-')
  );
  companionPost = allPosts.find(p => 
    p.id && p.id.includes(post.data.companion)
  );
}

// Get related posts (same day)
const relatedPosts = [];
if (day) {
  const allPosts = await getCollection('docs', (entry) => 
    entry.id && entry.id.startsWith('blog/day-') && entry.id !== post.id
  );
  
  relatedPosts.push(...allPosts.filter(p => {
    const match = p.id.match(/day-(\d+)/);
    return match && parseInt(match[1]) === day;
  }));
}
---

<StarlightPage frontmatter={{ 
  title: post.data.title, 
  description: post.data.description 
}}>
  
  <!-- Post Meta -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <Badge 
      text={perspective === 'human' ? '👨‍💻 Human Perspective' : '🤖 Claude Perspective'} 
      variant={perspective === 'human' ? 'note' : 'success'} 
    />
    {post.data.date && (
      <span style="color: var(--sl-color-text-accent); font-size: 0.9rem;">
        {new Date(post.data.date).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}
      </span>
    )}
  </div>

  {day && (
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <Badge text={`Day ${day}`} variant="caution" />
      {companionPost && (
        <a href={`/blog/${companionPost.id.replace('blog/', '')}/`} style="color: var(--sl-color-accent); text-decoration: none; font-weight: 500;">
          {perspective === 'human' ? '🤖 See Claude\'s perspective' : '👨‍💻 See Human\'s perspective'} →
        </a>
      )}
    </div>
  )}
  
  {post.data.excerpt && (
    <Aside type="note" title="Summary">
      {post.data.excerpt}
    </Aside>
  )}
  
  {post.data.tags && (
    <div style="margin-bottom: 2rem;">
      {post.data.tags.map((tag: string) => (
        <Badge text={tag} variant="default" />
        <span style="margin-right: 0.5rem;"></span>
      ))}
    </div>
  )}
  
  <!-- Post Content -->
  <Content />
  
  <!-- Related Posts / Companion -->
  {relatedPosts.length > 0 && (
    <div style="margin-top: 3rem;">
      <h3>Related Posts from Day {day}</h3>
      
      <CardGrid>
        {relatedPosts.map((relatedPost) => {
          const relatedPerspective = relatedPost.data.authors?.includes('human') ? 'human' : 'claude';
          return (
            <Card 
              title={relatedPerspective === 'human' ? '👨‍💻 Human Perspective' : '🤖 Claude Perspective'}
              icon={relatedPerspective === 'human' ? 'user' : 'rocket'}
            >
              <h4 style="margin: 0 0 0.5rem 0;">
                <a href={`/blog/${relatedPost.id.replace('blog/', '')}/`} style="color: var(--sl-color-text); text-decoration: none;">
                  {relatedPost.data.title}
                </a>
              </h4>
              <p style="margin: 0; color: var(--sl-color-text-accent);">{relatedPost.data.excerpt}</p>
            </Card>
          );
        })}
      </CardGrid>
      
      {day && (
        <div style="text-align: center; margin-top: 1.5rem;">
          <a href={`/blog/day-${day}/both/`} style="background: var(--sl-color-accent); color: var(--sl-color-white); padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; font-weight: 500;">
            📊 Read Both Perspectives Side-by-Side
          </a>
        </div>
      )}
    </div>
  )}
  
  <!-- Navigation -->
  <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--sl-color-hairline);">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      {day && day > 1 ? (
        <a href={`/blog/day-${day - 1}/both/`} style="color: var(--sl-color-accent); text-decoration: none; padding: 0.5rem 1rem; border: 1px solid var(--sl-color-accent); border-radius: 0.375rem;">
          ← Day {day - 1}
        </a>
      ) : (
        <span></span>
      )}
      
      <a href="/blog/" style="color: var(--sl-color-accent); text-decoration: none; padding: 0.5rem 1rem; border: 1px solid var(--sl-color-accent); border-radius: 0.375rem;">
        All Posts
      </a>
      
      <span style="opacity: 0.7; padding: 0.5rem 1rem;">
        To be continued...
      </span>
    </div>
  </div>
</StarlightPage>