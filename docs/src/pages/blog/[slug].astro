---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';
import { Card, CardGrid, Aside } from '@astrojs/starlight/components';
import { getCollection, type CollectionEntry, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('docs', (entry) => 
    entry.id && entry.id.startsWith('blog/day-')
  );
  
  return posts.map((post) => ({
    params: { slug: post.id.replace('blog/', '') },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'docs'>;
}

const { post } = Astro.props;

// Try to render the content
let Content;
try {
  const result = await render(post);
  Content = result.Content;
} catch (error) {
  console.error('Error rendering post:', error);
  // Fallback if render doesn't work
  Content = () => null;
}

// Extract collaboration data
const dayMatch = post.id.match(/day-(\d+)/);
const day = dayMatch ? parseInt(dayMatch[1]) : null;
const perspective = post.data.authors?.includes('human') ? 'human' : 'claude';

// Find companion post
let companionPost = null;
if (post.data.companion) {
  const allPosts = await getCollection('docs', (entry) => 
    entry.id && entry.id.startsWith('blog/day-')
  );
  companionPost = allPosts.find(p => 
    p.id && p.id.includes(post.data.companion)
  );
}

// Get related posts (same day)
const relatedPosts = [];
if (day) {
  const allPosts = await getCollection('docs', (entry) => 
    entry.id && entry.id.startsWith('blog/day-') && entry.id !== post.id
  );
  
  relatedPosts.push(...allPosts.filter(p => {
    const match = p.id.match(/day-(\d+)/);
    return match && parseInt(match[1]) === day;
  }));
}
---

<StarlightPage frontmatter={{ 
  title: post.data.title, 
  description: post.data.description 
}}>
  
  <!-- Post Meta -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <span style="color: var(--sl-color-text-accent); font-size: 0.9rem;">
      {perspective === 'human' ? '👨‍💻 Human Perspective' : '🤖 Claude Perspective'}
    </span>
    {post.data.date && (
      <span style="color: var(--sl-color-text-accent); font-size: 0.9rem;">
        {new Date(post.data.date).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}
      </span>
    )}
  </div>

  {day && (
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <span style="color: var(--sl-color-accent); font-weight: 600;">Day {day}</span>
      {companionPost && (
        <a href={`/blog/${companionPost.id.replace('blog/', '')}/`} style="color: var(--sl-color-accent); text-decoration: none; font-size: 0.9rem;">
          {perspective === 'human' ? '🤖 See Claude\'s perspective' : '👨‍💻 See Human\'s perspective'} →
        </a>
      )}
    </div>
  )}
  
  {post.data.excerpt && (
    <Aside type="note" title="Summary">
      {post.data.excerpt}
    </Aside>
  )}
  
  {post.data.tags && (
    <div style="margin-bottom: 2rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
      {post.data.tags.map((tag: string) => (
        <span style="color: var(--sl-color-text-accent); font-size: 0.85rem;">
          #{tag}
        </span>
      ))}
    </div>
  )}
  
  <!-- Post Content -->
  <Content />
  
  <!-- Related Posts / Companion -->
  {relatedPosts.length > 0 && (
    <div style="margin-top: 3rem;">
      <h3>Related Posts from Day {day}</h3>
      
      {relatedPosts.map((relatedPost) => {
        const relatedPerspective = relatedPost.data.authors?.includes('human') ? 'human' : 'claude';
        return (
          <Card 
            title={relatedPerspective === 'human' ? '👨‍💻 Human Perspective' : '🤖 Claude Perspective'}
            icon={relatedPerspective === 'human' ? 'user' : 'rocket'}
          >
            <h4 style="margin: 0 0 0.5rem 0;">
              <a href={`/blog/${relatedPost.id.replace('blog/', '')}/`} style="color: var(--sl-color-text); text-decoration: none;">
                {relatedPost.data.title}
              </a>
            </h4>
            <p style="margin: 0; color: var(--sl-color-text-accent);">{relatedPost.data.excerpt}</p>
          </Card>
        );
      })}
      
      {day && (
        <div style="text-align: center; margin-top: 1.5rem;">
          <Card title="📊 Compare Both Views">
            <p>See how human curiosity and AI insights approached the same challenges on Day {day}.</p>
            <p><a href={`/blog/day-${day}/both/`}>Read Both Perspectives Side-by-Side →</a></p>
          </Card>
        </div>
      )}
    </div>
  )}
  
  <!-- Navigation -->
  <hr style="margin: 3rem 0 2rem 0; border: 1px solid var(--sl-color-hairline);" />
  <nav style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
    {day && day > 1 ? (
      <a href={`/blog/day-${day - 1}/both/`}>← Day {day - 1}</a>
    ) : (
      <span></span>
    )}
    
    <a href="/blog/">All Posts</a>
    
    <span style="opacity: 0.7;">To be continued...</span>
  </nav>
</StarlightPage>